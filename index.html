<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Preguntas Bíblicas</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Generales y Fondo Azul Oscuro */
        body {
            /* FUENTE ACTUALIZADA A 'Poppins' */
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0056b3; 
            color: #333;
            min-height: 100vh;
            /* RUTA DEL FONDO CORREGIDA A RELATIVA */
            background-image: url('assets/seamless-pattern-with-paper-books-home-library-book-stacks-glasses-vector.jpg');
            background-repeat: repeat;
            background-blend-mode: multiply; 
            background-size: 200px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow-x: hidden; 
        }

        /* Preloader */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #004085;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-animation {
            width: 80%;
            max-width: 400px;
            background-color: #f3f3f3;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid #FFC107;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #loading-bar {
            height: 30px;
            width: 0%;
            background-color: #FFC107;
            transition: width 0.1s linear;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #loading-percentage {
            color: #004085;
            font-weight: bold;
            position: absolute;
            font-size: 1.2em;
        }

        #play-button {
            padding: 15px 40px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }

        #play-button:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        #play-button:disabled {
            background-color: #6c757d; 
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Pantalla de Bienvenida */
        #welcome-section {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 400px;
            transition: opacity 0.5s ease;
            opacity: 0; 
        }
        
        #welcome-section.active {
            opacity: 1;
        }
        
        #welcome-section h1 {
            color: #0056b3;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        #name-input {
            padding: 10px 15px;
            margin-top: 15px;
            border: 2px solid #ccc;
            border-radius: 10px;
            font-size: 1.1em;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        /* Sección de Juego */
        #game-section {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 600px;
            width: 95%;
            margin-top: 60px; /* Espacio para la barra superior */
            transition: opacity 0.5s ease;
            opacity: 0;
        }
        
        #game-section.active {
            opacity: 1;
        }

        #top-bar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #004085; /* Azul oscuro */
            padding: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            color: white;
        }
        
        #top-bar-container.visible {
            display: block;
        }

        #top-bar {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        #profile-info {
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        #profile-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FFC107;
            margin-right: 10px;
        }
        
        #coins-display {
            display: flex;
            align-items: center;
            background-color: #FFC107;
            color: #004085;
            padding: 5px 15px;
            border-radius: 20px;
            margin-left: 15px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        #coins-display span {
            font-weight: 900;
            margin-left: 5px;
        }
        
        #level-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        #profile-username-small {
            font-size: 0.9em;
        }
        
        #profile-level-small {
            font-size: 0.75em;
            color: #ccc;
        }

        /* Stars/Shield */
        #star-counter-container {
            display: flex;
            align-items: center;
            font-size: 1.2em;
            color: #FFC107;
            margin-left: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .star, #shield-display {
            transition: opacity 0.3s ease, color 0.3s ease;
        }
        
        .separator {
            color: #6c757d;
            margin: 0 5px;
        }

        .faded {
            opacity: 0.3;
        }
        
        .star.lost-star {
            opacity: 0;
            transform: scale(0.5);
        }

        /* Menú de Ajustes */
        #menu-icon {
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 20px;
            transition: transform 0.3s;
        }
        
        #menu-icon.open-icon {
            transform: rotate(90deg);
        }
        
        #dropdown-menu {
            position: absolute;
            top: 60px; /* Debajo de la barra superior */
            right: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            list-style: none;
            padding: 10px 0;
            width: 200px;
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        #dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #dropdown-menu li {
            padding: 10px 20px;
            cursor: pointer;
            color: #333;
            text-align: left;
            transition: background-color 0.2s;
            font-weight: 600;
        }

        #dropdown-menu li:hover {
            background-color: #f8f9fa;
        }
        
        /* Contenedor de Quiz */
        #quiz-container {
            display: block; 
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        #question-text {
            font-size: 1.4em;
            margin-bottom: 25px;
            color: #004085;
            font-weight: 700;
            min-height: 70px; /* Evitar que el contenedor salte */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-button {
            padding: 15px;
            background-color: #e9ecef;
            border: 2px solid #ccc;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .option-button:hover:not(:disabled) {
            background-color: #ffda79;
            border-color: #FFC107;
            transform: translateY(-1px);
        }

        .option-button:disabled {
            cursor: not-allowed;
        }

        .option-button.correct {
            background-color: #28a745;
            color: white;
            border-color: #218838;
        }

        .option-button.incorrect {
            background-color: #dc3545;
            color: white;
            border-color: #c82333;
        }
        
        .wildcard-disabled {
            opacity: 0.2;
            pointer-events: none; /* Asegura que no se puedan clickear */
        }

        /* Tooltip de Respuesta */
        #answer-tooltip {
            position: fixed;
            background-color: #004085;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 100;
            transform: translate(-50%, -100%) scale(0); 
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            text-align: center;
            width: 250px;
            max-width: 80%;
            pointer-events: none;
        }
        
        #answer-tooltip.show {
            transform: translate(-50%, -120%) scale(1);
            opacity: 1;
        }
        
        #tooltip-title {
            font-weight: 700;
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        #tooltip-correct-answer-text {
            display: block;
            margin-top: 5px;
            font-style: italic;
        }
        
        #tooltip-reference {
            font-size: 0.8em;
            color: #ccc;
            display: block;
            margin-top: 3px;
        }

        /* Comodines */
        #wildcard-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 20px;
        }
        
        .wildcard-button {
            background-color: #20c997;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .wildcard-button:hover:not(:disabled) {
            background-color: #17a2b8;
        }
        
        .wildcard-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .wildcard-button span {
            font-size: 1.2em;
            margin-right: 5px;
        }
        
        .wildcard-cost {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #FFC107;
            color: #004085;
            padding: 2px 6px;
            border-radius: 50%;
            font-size: 0.7em;
            font-weight: 900;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Modales Generales (Reglas, Ajustes, Éxito, Democión, Penalización) */
        .level-modal, #settings-modal, #rules-modal, #hint-tooltip {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }

        .level-modal.visible, #settings-modal.visible, #rules-modal.visible, #hint-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 450px;
            text-align: center;
            color: #333;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .level-modal.visible .modal-content, #settings-modal.visible .modal-content, #rules-modal.visible .modal-content, #hint-tooltip.visible .modal-content {
            transform: scale(1);
        }
        
        .modal-content h2 {
            font-size: 1.8em;
            color: #0056b3;
            margin-bottom: 15px;
        }
        
        .modal-content p {
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        .modal-button {
            padding: 10px 30px;
            background-color: #FFC107;
            color: #004085;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        
        .modal-button:hover {
            background-color: #ff9800;
        }

        /* Estilos específicos de Ajustes (Toggle) */
        #settings-content {
            text-align: left;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }

        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }

        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 34px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }

        input:checked + .slider {
          background-color: #2196F3;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
          transform: translateX(26px);
        }
        
        /* Modal de Ascenso (Level Up) */
        #level-up-modal .modal-content {
            background: linear-gradient(135deg, #0056b3, #004085);
            color: white;
            border: 5px solid #FFC107;
            padding: 40px;
        }
        
        #level-up-modal h2 {
            color: #FFC107;
            font-size: 2.2em;
            margin-bottom: 20px;
        }
        
        #level-up-question {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 30px;
            color: white;
        }

        #level-up-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        #level-up-options .option-button {
            background-color: #f8f9fa;
            border-color: #FFC107;
            color: #004085;
        }
        
        #level-up-options .option-button.correct {
            background-color: #4CAF50;
            color: white;
        }
        
        #level-up-options .option-button.incorrect {
            background-color: #f44336;
            color: white;
        }
        
        #level-up-timer {
            margin-top: 15px;
            font-size: 1.1em;
            color: #FFC107;
            font-weight: 700;
        }

        /* Modal de Animación de Escudo */
        #shield-animation-modal {
            background: rgba(0, 0, 0, 0.95);
        }
        
        #animated-shield {
            font-size: 10em;
            color: white;
            text-shadow: 0 0 20px #FFC107;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s ease;
        }

        #animated-shield.shatter-active {
            animation: shatter 1.5s forwards;
            opacity: 1;
        }

        @keyframes shatter {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { 
                transform: scale(0.1) rotate(-30deg); 
                opacity: 0;
                filter: blur(5px);
            }
        }
        
        /* Animación de Estrella que Vuela */
        @keyframes flyToStar {
            to {
                transform: translate(var(--dx), var(--dy)) scale(0.5);
                opacity: 0;
            }
        }

        .animated-star {
            position: fixed;
            font-size: 2em;
            z-index: 1000;
            transition: all 1s ease-out;
            pointer-events: none;
        }
        
        /* Reglas y Pista (Hint) */
        #rules-modal .modal-content {
            text-align: left;
        }
        
        #rules-modal h2, #hint-tooltip h2 {
            color: #28a745;
        }
        
        #hint-tooltip .modal-content {
            background-color: #f0f8ff;
            border: 2px solid #17a2b8;
        }
        
        #hint-text {
            color: #17a2b8;
            font-style: italic;
        }

    </style>
</head>
<body>

    <div id="preloader">
        <div class="loading-animation">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-percentage">0%</div>
        <h2 style="color: white; margin-top: 20px;">Cargando Preguntas Bíblicas...</h2>
        <button id="play-button" disabled>CARGANDO...</button>
    </div>
    
    <div id="top-bar-container">
        <div id="top-bar">
            <div id="profile-info">
                <img src="assets/pblogo.png" alt="Logo"> 
                <div id="level-info">
                    <span id="profile-username-small">Jugador</span>
                    <span id="profile-level-small">Nivel: Discípulo I</span>
                </div>
                <div id="coins-display">
                    🪙 <span id="coins-value">20</span>
                </div>
            </div>
            
            <div style="display: flex; align-items: center;">
                <div id="star-counter-container">
                    <span id="shield-display" class="faded">🛡️</span><span class="separator">|</span>
                </div>
                
                <span id="menu-icon">&#9776;</span>
            </div>
        </div>
    </div>
    
    <ul id="dropdown-menu">
        <li onclick="showSettingsModal()">⚙️ Ajustes</li>
        <li onclick="showRulesModal()">📚 Reglas</li>
        </ul>

    <section id="welcome-section">
        <h1>Bíblica Mente</h1>
        <p>Pon a prueba tus conocimientos de la Biblia. Escribe tu nombre para empezar a jugar.</p>
        <input type="text" id="name-input" placeholder="Tu Nombre">
    </section>

    <section id="game-section">
        <div id="quiz-container">
            <h2 id="question-text"></h2>
            <div id="options-container">
                </div>
        </div>
        
        <div id="wildcard-container">
            <button class="wildcard-button" data-type="5050" data-cost="10" onclick="useWildcard('5050')">
                <span>🔪</span> 50/50 
                <span class="wildcard-cost">10</span>
            </button>
            <button class="wildcard-button" data-type="skip" data-cost="15" onclick="useWildcard('skip')">
                <span>⏩</span> Saltar 
                <span class="wildcard-cost">15</span>
            </button>
            <button class="wildcard-button" data-type="hint" data-cost="20" onclick="useWildcard('hint')">
                <span>💡</span> Pista 
                <span class="wildcard-cost">20</span>
            </button>
        </div>
    </section>
    
    <div id="answer-tooltip">
        <div id="tooltip-title">¡INCORRECTO!</div>
        <div id="tooltip-correct-answer-text"></div>
        <div id="tooltip-reference"></div>
    </div>

    <div id="rules-modal" class="level-modal">
        <div class="modal-content">
            <h2>📚 Reglas de Juego</h2>
            <p><strong>Objetivo:</strong> Alcanzar el nivel **Experto X**.</p>
            <p><strong>Estrellas:</strong> Necesitas **5 estrellas** 🌟 para optar al ascenso de nivel.</p>
            <p><strong>Respuestas:</strong></p>
            <ul>
                <li>✅ **Correcta:** Ganas 1 estrella y 2 monedas 🪙.</li>
                <li>❌ **Incorrecta:** Pierdes 1 estrella.</li>
            </ul>
            <p><strong>Penalización:</strong> Si fallas con **0 estrellas**:</p>
            <ul>
                <li>Si tienes un **Escudo** 🛡️, lo pierdes y sigues en el mismo nivel.</li>
                <li>Si no tienes Escudo, **desciendes un Sub-nivel**.</li>
            </ul>
            <p><strong>Prueba de Ascenso:</strong> Al tener 5 estrellas, enfrentas una pregunta de nivel superior con **tiempo limitado**. Si aciertas, **asciendes de nivel**, obtienes un Escudo y 10 monedas. Si fallas, recibes una penalización de estrellas.</p>
            <button class="modal-button" id="start-game-button">¡EMPEZAR A JUGAR!</button>
        </div>
    </div>

    <div id="level-up-modal" class="level-modal">
        <div class="modal-content">
            <h2>PRUEBA DE ASCENSO</h2>
            <p id="level-up-timer">Tiempo restante: 15s</p>
            <h3 id="level-up-question"></h3>
            <div id="level-up-options">
                </div>
        </div>
    </div>

    <div id="success-modal" class="level-modal">
        <div class="modal-content">
            <h2 id="success-title"></h2>
            <p id="success-message"></p>
            <button class="modal-button" id="next-level-button">Continuar</button>
        </div>
    </div>
    
    <div id="demotion-modal" class="level-modal">
        <div class="modal-content">
            <h2 id="demotion-title"></h2>
            <p id="demotion-message"></p>
            <button class="modal-button" id="demotion-button">Aceptar Descenso</button>
        </div>
    </div>
    
    <div id="penalty-modal" class="level-modal">
        <div class="modal-content">
            <h2 id="penalty-title"></h2>
            <p id="penalty-message"></p>
            <button class="modal-button" id="penalty-button">Aceptar</button>
        </div>
    </div>

    <div id="hint-tooltip" class="level-modal">
        <div class="modal-content">
            <h2>💡 Pista</h2>
            <p id="hint-text"></p>
            <button class="modal-button" onclick="hideHintModal()">Entendido</button>
        </div>
    </div>

    <div id="settings-modal" class="level-modal" onclick="hideSettingsModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>⚙️ Ajustes</h2>
            <div id="settings-content">
                <div class="setting-item">
                    <span>Efectos de Sonido</span>
                    <label class="switch">
                      <input type="checkbox" id="audio-toggle" checked>
                      <span class="slider"></span>
                    </label>
                </div>
            </div>
            <button class="modal-button" style="margin-top: 20px;" onclick="hideSettingsModal()">Cerrar</button>
        </div>
    </div>
    
    <div id="shield-animation-modal" class="level-modal">
        <span id="animated-shield">🛡️</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuIcon = document.getElementById('menu-icon');
            const dropdownMenu = document.getElementById('dropdown-menu');
            
            // Función para alternar la visibilidad del menú
            function toggleMenu() {
                dropdownMenu.classList.toggle('open');
                
                // --- Lógica para cambiar el ícono ---
                if (dropdownMenu.classList.contains('open')) {
                    menuIcon.innerHTML = '&#215;'; // Símbolo de Multiplicación (X)
                    menuIcon.classList.add('open-icon');
                } else {
                    menuIcon.innerHTML = '&#9776;'; // Símbolo de Hamburguesa
                    menuIcon.classList.remove('open-icon');
                }
            }

            // Abre o cierra el menú al hacer clic en el icono
            menuIcon.addEventListener('click', (event) => {
                event.stopPropagation(); 
                toggleMenu();
            });

            // Cierra el menú si se hace clic fuera de él
            document.addEventListener('click', (event) => {
                if (dropdownMenu.classList.contains('open') && !dropdownMenu.contains(event.target) && event.target !== menuIcon) {
                    // Cierre manual también debe actualizar el ícono
                    dropdownMenu.classList.remove('open');
                    menuIcon.innerHTML = '&#9776;'; 
                    menuIcon.classList.remove('open-icon');
                }
            });
            
            // Lógica de juego original (continúa)
            
            // ===============================================
            // *** CAMBIO CRÍTICO: RUTA CORREGIDA DEL JSON ***
            // La ruta se cambia a RELATIVA ('assets/preguntas.json') para solucionar el bloqueo CORS/Acceso.
            // ===============================================
            const JSON_URL = 'assets/preguntas.json'; 
            // ===============================================
            
            let questionBank = []; 
            let currentQuestionIndex = 0; 
            let hasAnswered = false;
            let isWildcardActive = false; 
            
            // --- URLs de AUDIO (Rutas corregidas a RELATIVAS) ---
            const AUDIO_CORRECT = 'assets/efectos/winner-game-sound-404167.mp3';
            const AUDIO_INCORRECT = 'assets/efectos/fail-144746.mp3';
            const AUDIO_SHIELD = 'assets/efectos/bubble-pops-and-ding-type-3-235798.mp3';
            const AUDIO_DEMOTION = 'assets/efectos/playful-failure-310480.mp3';
            const AUDIO_ASCENSION_FAIL = 'assets/efectos/brass-fail-11-a-207140.mp3';
            
            // Audios para comodines
            const AUDIO_WILDCARD_5050 = 'assets/efectos/bush-cut-103503.mp3';
            const AUDIO_WILDCARD_SKIP = 'assets/efectos/coin-upaif-14631.mp3';
            const AUDIO_WILDCARD_HINT = 'assets/efectos/scale-e6-14577.mp3';
            
            const AUDIO_ASCENSION_SUCCESS = [
                'assets/efectos/11l-victory_trumpet-1749704501065-358769.mp3',
                'assets/efectos/11l-victory_trumpet-1749704498589-358767.mp3',
                'assets/efectos/11l-victory_trumpet-1749704496881-358778.mp3'
            ];
            
            // --- NUEVAS REFERENCIAS DE AUDIO Y AJUSTES ---
            const AUDIO_LEVEL_UP_TIMER = 'assets/efectos/slow-cinematic-clock-ticking-tension-2-323078.mp3';
            
            // --- LÓGICA DE PROGRESIÓN y MONEDAS ---
            let currentStars = 0;
            let hasShield = false; 
            let currentLevelIndex = 0; 
            let currentSubLevel = 1;
            let currentCoins = 20; 
            const COINS_PER_CORRECT_ANSWER = 2; 

            const LEVEL_CONFIG = [
                { name: "Discípulo", maxSubLevels: 5 },
                { name: "Maestro", maxSubLevels: 7 },
                { name: "Experto", maxSubLevels: 10 }
            ];
            const STAR_THRESHOLD = 5;
            const PENALTY_STARS = 3; 
            const TOTAL_STARS_DISPLAY = STAR_THRESHOLD; 
            
            // Costos de comodines
            const WILDCARD_COSTS = {
                '5050': 10,
                'skip': 15,
                'hint': 20
            };
            
            // --- NUEVAS REFERENCIAS DE AUDIO Y AJUSTES ---
            const audioToggle = document.getElementById('audio-toggle');
            const settingsModal = document.getElementById('settings-modal'); 

            // Carga el estado del audio o usa 'true' por defecto
            let isAudioEnabled = localStorage.getItem('isAudioEnabled') === 'false' ? false : true; 

            // **NUEVA VARIABLE PARA EL TEMPORIZADOR**
            let levelUpTimerInterval = null;
            let timeLeft = 0; 
            const LEVEL_UP_TIME = 15; // Segundos
            
            // --- REFERENCIAS DE ELEMENTOS DE JUEGO ---
            const profileLevelSmall = document.getElementById('profile-level-small');
            const coinsValueElement = document.getElementById('coins-value'); 
            const starCounterContainer = document.getElementById('star-counter-container');
            const shieldDisplay = document.getElementById('shield-display'); 
            const levelUpModal = document.getElementById('level-up-modal');
            const optionsContainer = document.getElementById('options-container');
            const wildcardContainer = document.getElementById('wildcard-container');
            const tooltip = document.getElementById('answer-tooltip');
            const hintTooltip = document.getElementById('hint-tooltip'); 
            const levelUpTimerElement = document.getElementById('level-up-timer'); // **NUEVA REFERENCIA**

            // Referencias de Modales
            const successModal = document.getElementById('success-modal');
            const demotionModal = document.getElementById('demotion-modal');
            const shieldAnimationModal = document.getElementById('shield-animation-modal');
            const penaltyModal = document.getElementById('penalty-modal'); 

            // --- UTILIDADES DE AUDIO (MODIFICADAS) ---
            /** * Reproduce el sonido solo si el audio está habilitado.
             */
            function playSound(url) {
                if (!isAudioEnabled) return; // Nueva verificación
                const audio = new Audio(url);
                audio.play().catch(e => console.error("Error al reproducir audio:", e));
            }

            /** * Sincroniza el estado global (isAudioEnabled) con el checkbox del modal y localStorage. 
             */
            function syncAudioState() {
                isAudioEnabled = audioToggle.checked;
                localStorage.setItem('isAudioEnabled', isAudioEnabled);
            }
            
            /** * Muestra el modal de ajustes y carga el estado actual del audio.
             */
            window.showSettingsModal = function() {
                // 1. Cargar el estado actual desde la variable global
                audioToggle.checked = isAudioEnabled; 
                settingsModal.classList.add('visible');
                
                // Cierra el menú desplegado si está abierto
                dropdownMenu.classList.remove('open');
                menuIcon.innerHTML = '&#9776;'; 
                menuIcon.classList.remove('open-icon');
            }
            
            /** * Oculta el modal de ajustes.
             */
            window.hideSettingsModal = function() {
                settingsModal.classList.remove('visible');
            }
            
            // --- Escuchador de Eventos para el Switch ---
            audioToggle.addEventListener('change', syncAudioState);
            
            function playRandomAscensionSound() {
                if (!isAudioEnabled) return; // Nueva verificación
                const randomIndex = Math.floor(Math.random() * AUDIO_ASCENSION_SUCCESS.length);
                playSound(AUDIO_ASCENSION_SUCCESS[randomIndex]);
            }
            
            // --- UTILIDADES DE JUEGO Y DISPLAY (Sin cambios funcionales) ---

            function shuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function convertToRoman(num) {
                if (num <= 0) return '';
                const map = { 1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI', 7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X' };
                return map[num] || num.toString();
            }

            /** Actualiza el texto del nivel del jugador. */
            function updateLevelDisplay() {
                const levelInfo = LEVEL_CONFIG[currentLevelIndex];
                profileLevelSmall.textContent = `Nivel: ${levelInfo.name} ${convertToRoman(currentSubLevel)}`;
            }
            
            /** Actualiza el valor de monedas. */
            function updateCoinDisplay() {
                coinsValueElement.textContent = currentCoins;
                updateWildcardButtons();
            }

            /** Actualiza las estrellas y el escudo visualmente. */
            function updateStarDisplay() {
                let existingStars = starCounterContainer.querySelectorAll('.star');
                if (existingStars.length !== TOTAL_STARS_DISPLAY) {
                    // Reconstruir la estructura si es necesario
                    starCounterContainer.innerHTML = '<span id="shield-display" class="faded">🛡️</span><span class="separator">|</span>';
                    for (let i = 1; i <= TOTAL_STARS_DISPLAY; i++) {
                        const star = document.createElement('span');
                        star.classList.add('star');
                        star.textContent = '🌟'; 
                        starCounterContainer.appendChild(star);
                    }
                }
                existingStars = starCounterContainer.querySelectorAll('.star'); 

                for (let i = 0; i < TOTAL_STARS_DISPLAY; i++) {
                    if (i < currentStars) {
                        existingStars[i].classList.remove('faded');
                    } else {
                        existingStars[i].classList.add('faded');
                    }
                }
                
                const shieldElement = document.getElementById('shield-display');
                if (hasShield) {
                    shieldElement.classList.remove('faded');
                } else {
                    shieldElement.classList.add('faded');
                }
            }
            
            /** Deshabilita comodines si el jugador no tiene suficientes monedas. */
            function updateWildcardButtons() {
                const buttons = document.querySelectorAll('.wildcard-button');
                buttons.forEach(button => {
                    const cost = parseInt(button.dataset.cost);
                    if (currentCoins < cost) {
                        button.disabled = true;
                    } else if (!hasAnswered && !isWildcardActive) {
                        // Solo habilitar si no se ha respondido Y si no hay un comodín ya activo
                        button.disabled = false;
                    }
                });
                
                if (hasAnswered || isWildcardActive) {
                    // Deshabilitar todos si ya se respondió o hay una pista activa (para evitar más comodines)
                    buttons.forEach(button => button.disabled = true);
                }
            }
            
            // --- LÓGICA DE COMODINES (WILDCARDS) (Sin cambios funcionales) ---
            
            /** Manejador principal para el uso de comodines. */
            window.useWildcard = function(type) {
                const cost = WILDCARD_COSTS[type];
                if (currentCoins < cost) {
                    alert("¡Monedas insuficientes! Necesitas " + cost + " monedas.");
                    return;
                }
                
                if (isWildcardActive) {
                    alert("Ya tienes una pista activa. ¡Aprovéchala!");
                    return;
                }
                
                currentCoins -= cost;
                updateCoinDisplay();
                isWildcardActive = true; 
                
                const currentQuestion = questionBank[currentQuestionIndex];
                
                switch (type) {
                    case '5050':
                        playSound(AUDIO_WILDCARD_5050); 
                        apply5050(currentQuestion.answer);
                        break;
                    case 'skip':
                        playSound(AUDIO_WILDCARD_SKIP); 
                        skipQuestion();
                        break;
                    case 'hint':
                        playSound(AUDIO_WILDCARD_HINT); 
                        showHint(currentQuestion.hint);
                        break;
                }
                
                updateWildcardButtons(); 
            }

            /** Aplica el comodín 50/50. */
            function apply5050(correctAnswer) {
                const options = Array.from(optionsContainer.children);
                let incorrectOptions = options.filter(btn => btn.textContent !== correctAnswer);
                
                shuffle(incorrectOptions); 
                
                for (let i = 0; i < 2; i++) {
                    if (incorrectOptions[i]) {
                        incorrectOptions[i].classList.add('wildcard-disabled');
                    }
                }
                
                isWildcardActive = false; 
                updateWildcardButtons(); 
            }

            /** Salta la pregunta actual. */
            function skipQuestion() {
                currentQuestionIndex++;
                displayQuestion();
                isWildcardActive = false; 
                updateWildcardButtons(); 
            }

            /** Muestra el modal de pista. */
            function showHint(hintText) {
                document.getElementById('hint-text').textContent = hintText;
                hintTooltip.classList.add('visible'); 
            }
            
            /** Oculta el modal de pista (llamada desde el botón "Entendido"). */
            window.hideHintModal = function() {
                hintTooltip.classList.remove('visible');
            }

            // --- LÓGICA DE CARGA DE DATOS (Sin cambios en la lógica) ---

            async function loadQuestions() {
                try {
                    // *** Ahora usa la ruta relativa, lo que soluciona el problema CORS ***
                    const response = await fetch(JSON_URL);
                    if (!response.ok) {
                        // Si hay un error (ej: archivo no encontrado 404), se lanza un error y se va al catch
                        throw new Error(`Error HTTP: ${response.status} - Verifique la ruta relativa: ${JSON_URL}`);
                    }
                    
                    const loadedQuestions = await response.json();
                    questionBank = shuffle(loadedQuestions); 
                    
                    const playButton = document.getElementById('play-button');
                    playButton.disabled = false;
                    playButton.textContent = "JUGAR";
                    
                } catch (error) {
                    console.error("❌ Fallo crítico al cargar las preguntas:", error);
                    const playButton = document.getElementById('play-button');
                    // Mensaje de error más útil para el usuario
                    playButton.textContent = "Error de Carga. (Ver Consola)"; 
                    playButton.style.backgroundColor = '#dc3545';
                }
            }
            
            // --- DISPLAY DE JUEGO (Sin cambios funcionales) ---

            function displayQuestion() {
                document.querySelectorAll('.level-modal').forEach(modal => {
                    modal.classList.remove('visible');
                });

                // **ASEGURARSE DE LIMPIAR EL TEMPORIZADOR**
                clearInterval(levelUpTimerInterval); 
                levelUpTimerInterval = null;

                if (currentQuestionIndex >= questionBank.length) {
                    questionBank = shuffle(questionBank);
                    currentQuestionIndex = 0;
                }
                
                if (currentStars >= STAR_THRESHOLD) {
                    showLevelUpQuestion();
                    return; 
                }

                const question = questionBank[currentQuestionIndex];
                document.getElementById('quiz-container').style.display = 'block';
                document.getElementById('question-text').textContent = question.question;
                optionsContainer.innerHTML = '';
                hasAnswered = false; 
                isWildcardActive = false; 
                
                const shuffledOptions = shuffle([...question.options]); 

                shuffledOptions.forEach((option) => {
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.textContent = option;
                    
                    button.addEventListener('click', () => {
                        if (!hasAnswered) {
                            checkAnswer(button, option, question);
                        }
                    });
                    
                    optionsContainer.appendChild(button);
                });
                
                updateWildcardButtons(); 
            }
            
            /** Verifica la respuesta de una pregunta normal. */
            function checkAnswer(selectedButton, selectedOption, question) {
                hasAnswered = true; 
                isWildcardActive = false; 
                hintTooltip.classList.remove('visible'); 
                updateWildcardButtons(); 
                
                const correctAnswer = question.answer;
                const reference = question.reference || "No disponible"; 
                const allOptionButtons = document.querySelectorAll('#options-container .option-button');
                
                // 1. Aplicar feedback visual y desactivar botones
                allOptionButtons.forEach(button => {
                    button.disabled = true; 
                    if (button.textContent === correctAnswer) {
                        button.classList.add('correct');
                    } 
                    if (button === selectedButton && selectedOption !== correctAnswer) {
                        button.classList.add('incorrect');
                    }
                    if (button !== selectedButton && button.textContent !== correctAnswer && !button.classList.contains('wildcard-disabled')) {
                        button.style.opacity = '0.6';
                    }
                });

                // 2. Lógica de Estrellas, Monedas y Avance
                if (selectedOption === correctAnswer) {
                    // CORRECTO
                    playSound(AUDIO_CORRECT); 
                    
                    currentCoins += COINS_PER_CORRECT_ANSWER;
                    updateCoinDisplay();

                    const startStarCount = currentStars;
                    currentStars = Math.min(startStarCount + 1, STAR_THRESHOLD); 
                    
                    if (currentStars > startStarCount) {
                        animateStar(selectedButton); 
                    } else {
                        setTimeout(() => {
                            currentQuestionIndex++;
                            displayQuestion();
                        }, 1000); 
                    }
                    
                } else {
                    // INCORRECTO: Lógica de penalización y ESCUDO
                    
                    let nextAction = '';

                    if (currentStars > 0) {
                        playSound(AUDIO_INCORRECT); 
                        currentStars--; 
                        animateStarLoss();
                        nextAction = 'advance';
                        
                    } else if (currentStars === 0) {
                        
                        if (hasShield) {
                            hasShield = false; 
                            updateStarDisplay(); 
                            showShieldShatterAnimation(); 
                            return; 

                        } else {
                            const isBaseLevel = currentLevelIndex === 0 && currentSubLevel === 1;
                            playSound(AUDIO_INCORRECT); 
                            
                            if (isBaseLevel) {
                                currentStars = 0; 
                                updateStarDisplay(); 
                                nextAction = 'advance'; 

                            } else {
                                nextAction = 'levelDown'; 
                            }
                        }
                    }

                    showTooltipAboveButton(selectedButton, correctAnswer, reference);
                    
                    // 3. Lógica de Tooltip y Avance/Descenso
                    setTimeout(() => {
                        
                        tooltip.classList.remove('show');
                        
                        if (nextAction === 'levelDown') {
                            handleLevelDown(); 
                        } else {
                            currentQuestionIndex++;
                            displayQuestion(); 
                        }
                        
                    }, 3000); 
                }
            }
            
            /** Inicia el juego. */
            function startGame() {
                currentStars = 0;
                hasShield = false; 
                currentLevelIndex = 0; 
                currentSubLevel = 1;
                currentQuestionIndex = 0; 
                // Restaurar/Reiniciar monedas a un valor inicial si se quiere empezar desde 0
                currentCoins = parseInt(localStorage.getItem('currentCoins') || 20); 

                updateLevelDisplay();
                updateStarDisplay();
                updateCoinDisplay(); 

                if (questionBank.length > 0) {
                    displayQuestion();
                } else {
                    alert("Error: Las preguntas no están cargadas.");
                }
            }

            function advanceLevel() {
                playRandomAscensionSound(); 
                
                const levelInfo = LEVEL_CONFIG[currentLevelIndex];
                
                let newLevelName;
                let newSubLevelRoman;

                if (currentSubLevel < levelInfo.maxSubLevels) {
                    currentSubLevel++;
                    newLevelName = levelInfo.name;
                    newSubLevelRoman = convertToRoman(currentSubLevel);
                } else if (currentLevelIndex < LEVEL_CONFIG.length - 1) {
                    currentLevelIndex++;
                    currentSubLevel = 1; 
                    newLevelName = LEVEL_CONFIG[currentLevelIndex].name;
                    newSubLevelRoman = 'I';
                } else {
                    alert("¡Felicidades! ¡Has alcanzado el nivel MÁXIMO (Experto X)! El juego continuará.");
                    currentStars = 0; 
                    hasShield = true; 
                    currentCoins += 10; 
                    updateLevelDisplay();
                    updateStarDisplay();
                    updateCoinDisplay();
                    displayQuestion();
                    return;
                }
                
                currentStars = 0; 
                hasShield = true; 
                currentCoins += 10; 
                
                updateLevelDisplay();
                updateStarDisplay();
                updateCoinDisplay(); 
                
                showSuccessPopup(newLevelName, newSubLevelRoman);
            }

            // --- INICIALIZACIÓN DE LA APLICACIÓN ---

            // Mueve la lógica principal del DOMContentLoaded fuera de la anterior para evitar anidación
            (() => {
                const preloader = document.getElementById('preloader');
                const body = document.body;
                const playButton = document.getElementById('play-button');
                const nameInput = document.getElementById('name-input');
                const welcomeSection = document.getElementById('welcome-section');
                const gameSection = document.getElementById('game-section');
                const rulesModal = document.getElementById('rules-modal'); 
                const startGameButton = document.getElementById('start-game-button'); 

                gameSection.style.display = 'none'; 
                
                rulesModal.classList.remove('visible'); 
                
                // Cargar nombre del jugador si existe
                const storedName = localStorage.getItem('playerName');
                if (storedName) {
                    nameInput.value = storedName;
                    document.getElementById('profile-username-small').textContent = storedName;
                }
                
                // Listeners para botones de juego
                playButton.addEventListener('click', function() {
                    const userName = nameInput.value.trim();
                    if (playButton.disabled) return;

                    if (userName) {
                        localStorage.setItem('playerName', userName);
                        document.getElementById('profile-username-small').textContent = userName;
                        
                        welcomeSection.style.display = 'none'; 
                        rulesModal.classList.add('visible'); 
                    } else {
                        alert('Por favor, escribe tu nombre para empezar a jugar.');
                        nameInput.focus();
                    }
                });
                
                startGameButton.addEventListener('click', function() {
                    rulesModal.classList.remove('visible');
                    document.getElementById('top-bar-container').classList.add('visible');
                    showContentSection('welcome-section', 'game-section'); 
                    startGame(); 
                });
                
                // Simulador de carga (Preloader)
                let progress = 0;
                const loadingInterval = setInterval(() => {
                    if (progress < 85) progress += 2;
                    document.getElementById('loading-bar').style.width = progress + '%';
                    document.getElementById('loading-percentage').textContent = progress + '%';

                    if (progress >= 85) {
                        loadQuestions().finally(() => {
                            // Si la carga de preguntas es exitosa, el preloader finaliza
                            clearInterval(loadingInterval);
                            progress = 100;
                            document.getElementById('loading-bar').style.width = '100%';
                            document.getElementById('loading-percentage').textContent = '100%';
                            
                            preloader.style.opacity = '0';
                            
                            setTimeout(() => {
                                preloader.style.display = 'none';
                                body.classList.add('loaded'); 
                                welcomeSection.classList.add('active');
                                welcomeSection.style.display = 'flex';
                                
                                // Inicializar estados al final de la carga
                                audioToggle.checked = isAudioEnabled; 
                                updateLevelDisplay(); 
                                updateStarDisplay(); 
                                updateCoinDisplay(); 
                            }, 500); 
                        });
                    }
                }, 50);

                updateWildcardButtons(); 
            })();
            
            // --- Pegar funciones restantes (simplificadas) ---
            
            function showContentSection(hideId, showId) {
                document.getElementById(hideId).classList.remove('active');
                setTimeout(() => {
                    document.getElementById(hideId).style.display = 'none'; 
                    document.getElementById(showId).style.display = 'flex'; 
                    document.getElementById(showId).classList.add('active');
                }, 500); 
            }
            
            function showSuccessPopup(newLevelName, newSubLevelRoman) {
                document.getElementById('success-title').textContent = '¡ASCENSO CONSEGUIDO! 🌟';
                document.getElementById('success-message').innerHTML = `Has pasado la prueba. ¡Felicidades! Ahora eres **${newLevelName} ${newSubLevelRoman}** 🎉. ¡Has ganado un **ESCUDO** 🛡️ y **10 monedas** 🪙!`;
                successModal.classList.add('visible');
                
                document.getElementById('next-level-button').onclick = () => {
                    successModal.classList.remove('visible');
                    displayQuestion(); 
                };
            }
            
            function showPenaltyPopup() {
                playSound(AUDIO_ASCENSION_FAIL); 
                // **ASEGURARSE DE LIMPIAR EL TEMPORIZADOR**
                clearInterval(levelUpTimerInterval); 
                levelUpTimerInterval = null;
                
                const levelInfo = LEVEL_CONFIG[currentLevelIndex];
                const currentLevelRoman = convertToRoman(currentSubLevel);
                currentStars = PENALTY_STARS; 
                updateStarDisplay(); 
                document.getElementById('penalty-title').textContent = '¡PRUEBA FALLIDA! ❌';
                document.getElementById('penalty-message').innerHTML = `No has superado la prueba. Te quedas en **${levelInfo.name} ${currentLevelRoman}** y tu contador de estrellas se ha restablecido a **${PENALTY_STARS}** 🔻.`;
                
                penaltyModal.classList.add('visible');
                
                document.getElementById('penalty-button').onclick = () => {
                    penaltyModal.classList.remove('visible');
                    currentQuestionIndex++;
                    displayQuestion(); 
                };
            }
            
            function handleLevelDown() {
                playSound(AUDIO_DEMOTION); 
                const isBaseLevel = currentLevelIndex === 0 && currentSubLevel === 1;

                if (isBaseLevel) {
                    currentStars = 0; 
                    updateStarDisplay();
                    currentQuestionIndex++;
                    displayQuestion(); 
                    return;
                }
                
                let oldLevelName = LEVEL_CONFIG[currentLevelIndex].name;
                let oldSubLevelRoman = convertToRoman(currentSubLevel);
                
                let newLevelName;
                let newSubLevelRoman;

                if (currentSubLevel > 1) {
                    currentSubLevel--;
                    newLevelName = LEVEL_CONFIG[currentLevelIndex].name;
                    newSubLevelRoman = convertToRoman(currentSubLevel);
                } else { 
                    currentLevelIndex--;
                    currentSubLevel = LEVEL_CONFIG[currentLevelIndex].maxSubLevels;
                    newLevelName = LEVEL_CONFIG[currentLevelIndex].name;
                    newSubLevelRoman = convertToRoman(currentSubLevel);
                }
                
                currentStars = 0; 
                updateLevelDisplay();
                updateStarDisplay();
                
                document.getElementById('demotion-title').textContent = '¡HAS DESCENDIDO! 🔻';
                document.getElementById('demotion-message').innerHTML = `Por agotar tus estrellas, has descendido de **${oldLevelName} ${oldSubLevelRoman}** a **${newLevelName} ${newSubLevelRoman}**. Tu contador se ha reiniciado (0 estrellas).`;
                
                demotionModal.classList.add('visible');
                document.getElementById('demotion-button').onclick = () => {
                    demotionModal.classList.remove('visible');
                    currentQuestionIndex++;
                    displayQuestion(); 
                };
            }

            /**
             * FUNCIÓN PARA GESTIONAR EL TEMPORIZADOR DE ASCENSO
             */
            function startLevelUpTimer() {
                timeLeft = LEVEL_UP_TIME;
                levelUpTimerElement.textContent = `Tiempo restante: ${timeLeft}s`;

                // Variable para almacenar el audio de temporizador
                let timerAudio = null;
                
                // Iniciar el temporizador
                levelUpTimerInterval = setInterval(() => {
                    timeLeft--;
                    levelUpTimerElement.textContent = `Tiempo restante: ${timeLeft}s`;
                    
                    if (timeLeft <= 5) { // Advertencia visual en los últimos 5 segundos
                        levelUpTimerElement.style.color = '#dc3545'; // Rojo
                    } else {
                        levelUpTimerElement.style.color = '#FFC107'; // Dorado
                    }

                    // Reproducir sonido de temporizador cada segundo (solo si está activo)
                    if (isAudioEnabled && timeLeft > 0) {
                        // Reutilizar el mismo objeto Audio para evitar múltiples instancias
                        if (timerAudio) {
                            timerAudio.pause();
                            timerAudio.currentTime = 0;
                        }
                        timerAudio = new Audio(AUDIO_LEVEL_UP_TIMER);
                        timerAudio.play().catch(e => console.error("Error al reproducir audio:", e));
                    }

                    if (timeLeft <= 0) {
                        clearInterval(levelUpTimerInterval);
                        levelUpTimerInterval = null;
                        
                        // Detener el audio del temporizador cuando llega a cero
                        if (timerAudio) {
                            timerAudio.pause();
                            timerAudio.currentTime = 0;
                        }
                        
                        // Deshabilitar botones para evitar respuestas tardías
                        document.querySelectorAll('#level-up-options .option-button').forEach(btn => btn.disabled = true);
                        
                        levelUpModal.classList.remove('visible'); 
                        showPenaltyPopup(); // El tiempo se agotó, aplica penalización
                    }
                }, 1000);
            }
            
            function showLevelUpQuestion() {
                const question = questionBank[currentQuestionIndex];
                const levelUpQuestionElement = document.getElementById('level-up-question');
                const levelUpOptionsContainer = document.getElementById('level-up-options');
                
                levelUpModal.classList.add('visible');
                levelUpQuestionElement.textContent = question.question;
                levelUpOptionsContainer.innerHTML = '';

                startLevelUpTimer(); // **INICIAR EL TEMPORIZADOR**
                
                const shuffledOptions = shuffle([...question.options]); 
                
                shuffledOptions.forEach((option) => {
                    const button = document.createElement('button');
                    button.classList.add('option-button'); 
                    button.textContent = option;
                    
                    button.addEventListener('click', () => {
                        // Antes de verificar la respuesta, detener el temporizador
                        if (levelUpTimerInterval) {
                            clearInterval(levelUpTimerInterval);
                            levelUpTimerInterval = null;
                        }
                        checkLevelUpAnswer(button, option, question);
                    });
                    
                    levelUpOptionsContainer.appendChild(button);
                });
            }
            
            function checkLevelUpAnswer(selectedButton, selectedOption, question) {
                // **IMPORTANTE: El temporizador ya fue detenido en el listener**
                
                document.querySelectorAll('#level-up-options .option-button').forEach(btn => btn.disabled = true);
                const correctAnswer = question.answer;

                if (selectedOption === correctAnswer) {
                    playSound(AUDIO_CORRECT); 
                    selectedButton.classList.add('correct');
                    setTimeout(() => {
                        currentQuestionIndex++;
                        advanceLevel(); 
                    }, 1500);
                } else {
                    playSound(AUDIO_INCORRECT); 
                    selectedButton.classList.add('incorrect');
                    document.querySelectorAll('#level-up-options .option-button').forEach(btn => {
                        if (btn.textContent === correctAnswer) {
                            btn.classList.add('correct');
                        }
                    });
                    setTimeout(() => {
                        levelUpModal.classList.remove('visible'); 
                        showPenaltyPopup(); 
                    }, 1500); 
                }
            }
            
            function animateStar(startElement) {
                const star = document.createElement('span');
                star.textContent = '🌟';
                star.classList.add('animated-star');
                document.body.appendChild(star);

                const startRect = startElement.getBoundingClientRect();
                
                const starElements = Array.from(starCounterContainer.querySelectorAll('.star'));
                const targetStarIndex = currentStars - 1; 
                const targetStarElement = starElements[targetStarIndex];
                
                if (!targetStarElement) {
                    star.remove(); 
                    currentQuestionIndex++;
                    displayQuestion();
                    return;
                }
                
                const targetRect = targetStarElement.getBoundingClientRect();

                star.style.left = `${startRect.left + startRect.width / 2 - star.offsetWidth / 2}px`;
                star.style.top = `${startRect.top + startRect.height / 2 - star.offsetHeight / 2}px`;

                star.offsetHeight; 

                star.style.left = `${targetRect.left + targetRect.width / 2 - star.offsetWidth / 2}px`;
                star.style.top = `${targetRect.top + targetRect.height / 2 - star.offsetHeight / 2}px`;
                star.style.transform = 'scale(0.5)'; 

                setTimeout(() => {
                    star.remove();
                    updateStarDisplay(); 
                    
                    currentQuestionIndex++;
                    displayQuestion();
                }, 1000); 
            }
            
            function animateStarLoss() {
                const starElements = Array.from(starCounterContainer.querySelectorAll('.star'));
                const starToFade = starElements[currentStars]; 
                
                if (starToFade) {
                    starToFade.classList.add('lost-star');
                    setTimeout(() => {
                        starToFade.classList.remove('lost-star');
                        updateStarDisplay(); 
                    }, 500); 
                } else {
                    updateStarDisplay();
                }
            }
            
            function showShieldShatterAnimation() {
                playSound(AUDIO_SHIELD); 
                const animatedShield = document.getElementById('animated-shield');
                
                document.getElementById('answer-tooltip').classList.remove('show');

                shieldAnimationModal.classList.add('visible');
                animatedShield.classList.add('shatter-active');
                
                setTimeout(() => {
                    animatedShield.classList.remove('shatter-active');
                    shieldAnimationModal.classList.remove('visible');
                    currentQuestionIndex++;
                    displayQuestion(); 
                }, 1800); 
            }
            
            function showTooltipAboveButton(selectedButton, correctAnswer, reference) {
                const buttonRect = selectedButton.getBoundingClientRect();
                
                document.getElementById('tooltip-title').textContent = "¡INCORRECTO!";
                document.getElementById('tooltip-correct-answer-text').textContent = `Correcta: ${correctAnswer}`;
                document.getElementById('tooltip-reference').textContent = reference ? `(${reference})` : '(Sin Referencia)';
                
                const tooltipWidth = tooltip.offsetWidth || 250; 
                const viewportWidth = window.innerWidth;
                
                let tooltipX = buttonRect.left + buttonRect.width / 2;
                
                if (tooltipX < tooltipWidth / 2 + 10) {
                    tooltipX = tooltipWidth / 2 + 10;
                }
                if (tooltipX > viewportWidth - tooltipWidth / 2 - 10) {
                    tooltipX = viewportWidth - tooltipWidth / 2 - 10;
                }
                
                const tooltipY = buttonRect.top; 

                tooltip.style.left = `${tooltipX}px`;
                tooltip.style.top = `${tooltipY}px`;
                
                tooltip.classList.add('show');
            }
        });
    </script>
</body>
</html>
